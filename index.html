<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>City-Wide Permitting Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --panel: #ffffff; --muted: #6b7280; }
    .app-shell { position: relative; max-width: 1100px; margin: 16px auto; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 30px rgba(16,24,40,0.08); }
    .thread-hover:hover { background: rgba(99,102,241,0.05); }
    .icon-bubble { width: 44px; height: 44px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; }
    .section-divider { border-top: 1px solid rgba(15,23,42,0.06); }
    #chatbot-button { background-color: #2563eb; color: white; border-radius: 14px; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 10px 30px rgba(37,99,235,0.25); font-size: 24px; z-index: 10; transition: background-color 0.2s ease; }
    @media (min-width: 768px) { #chatbot-button { width: 80px; height: 80px; font-size: 28px; } }
    #chatbot-button:hover { background-color: #1d4ed8; }
    .modal-panel { position: relative; max-height: 90vh; overflow: auto; }
    .modal-close { position: absolute; top: 8px; right: 10px; background: transparent; border: none; font-size: 18px; cursor: pointer; line-height: 1; }
    .mobile-action-bar{ padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body class="bg-gray-50 font-sans text-slate-900">
  <main class="app-shell bg-white pb-20 md:pb-0">
    <header class="bg-blue-500 text-white p-4 sm:p-6 md:p-8">
      <div class="max-w-6xl mx-auto flex items-center justify-between gap-4">
        <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">City-Wide Permitting Assistant</h1>
        <button id="sidebar-toggle" class="md:hidden inline-flex items-center gap-2 bg-white/15 hover:bg-white/25 text-white rounded-lg px-3 py-2">
          <span class="text-sm">Menu</span>
          <span aria-hidden>‚ò∞</span>
        </button>
      </div>
    </header>

    <div class="flex flex-col md:flex-row">
      <!-- Sidebar -->
      <aside id="sidebar" class="left-nav bg-white border-b md:border-b-0 md:border-r border-gray-100 p-4 sm:p-6 w-full md:w-72 hidden md:block">
        <nav class="space-y-3">
          <a href="#" class="block text-base sm:text-lg text-slate-800 font-medium">Home</a>
          <a href="#" class="block text-slate-700">Browse</a>
          <a href="#forums" class="block text-slate-700">Forums</a>
          <a href="#permitting" class="block text-slate-700">Learn & Discuss City's Different Permits</a>
          <a href="#upcoming" class="block text-slate-700">Promote your upcoming businesses</a>
        </nav>

        <!-- Search -->
        <div class="mt-6">
          <h3 class="text-lg font-semibold mb-2">Search</h3>
          <div class="relative mb-6">
            <input type="text" id="sidebar-search" placeholder="Search..." class="w-full border border-gray-300 rounded-md p-2 pr-8 text-sm" />
            <span class="absolute right-2 top-2 text-gray-400">üîç</span>
          </div>
        </div>

        <!-- Useful Links -->
        <div class="mt-8">
          <h3 class="text-xl font-semibold mb-3">Useful links</h3>
          <ul class="space-y-3 text-slate-700 text-sm">
            <li><a href="https://planning.baltimorecity.gov/" target="_blank" rel="noopener" class="hover:underline">City Planning Department</a></li>
            <li><a href="https://dhcd.baltimorecity.gov/permits/permits-commercial" target="_blank" rel="noopener" class="hover:underline">Commercial Permit Guidelines</a></li>
            <li><a href="https://dhcd.baltimorecity.gov/permits/permits-residential" target="_blank" rel="noopener" class="hover:underline">Residential Permit Checklist</a></li>
            <li><a href="https://dhcd.baltimorecity.gov/permits/demolition" target="_blank" rel="noopener" class="hover:underline">Demolition Permit Requirements</a></li>
            <li><a href="https://dhcd.baltimorecity.gov/permits/use-occupancy" target="_blank" rel="noopener" class="hover:underline">Use & Occupancy Forms</a></li>
            <li><a href="https://bcrp.baltimorecity.gov/special-events-permitting" target="_blank" rel="noopener" class="hover:underline">Special Events Permitting</a></li>
            <li><a href="https://transportation.baltimorecity.gov/right-way-services-permits" target="_blank" rel="noopener" class="hover:underline">ROW (Right-of-Way) Permits</a></li>
            <li><a href="https://llb.baltimorecity.gov/" target="_blank" rel="noopener" class="hover:underline">Liquor Board / Alcohol Licensing</a></li>
            <li><a href="https://dhcd.baltimorecity.gov/permits" target="_blank" rel="noopener" class="hover:underline">Temporary Permits & Short-Term Approvals</a></li>
          </ul>

          <!-- Submit Question Button -->
          <div class="mt-6">
            <button id="submit-question-header" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-medium shadow-sm hover:bg-blue-700 transition">Submit your question to the City</button>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <section class="flex-1 p-4 sm:p-6 md:p-8">
        <div id="permitting">
          <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 mb-4">
            <h2 class="text-xl sm:text-2xl font-semibold">Learn and Discuss City's Different Permits</h2>
            <button id="start-discussion-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium shadow-sm w-full sm:w-auto" title="Start a discussion to get input from peers, city staff, and the public about your question and comments.">Start Discussion</button>
          </div>

          <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <ul class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-700">
              <li>‚Ä¢ Commercial Permits</li><li>‚Ä¢ Residential Permits</li><li>‚Ä¢ Demolition Permits</li><li>‚Ä¢ Use & Occupancy Permits</li>
              <li>‚Ä¢ Special Events Permits</li><li>‚Ä¢ ROW Permits</li><li>‚Ä¢ Liquor Board Permits</li><li>‚Ä¢ Temporary Permits</li>
            </ul>
          </div>

          <!-- Sample Discussions -->
          <div class="space-y-4">
            <article class="thread-hover p-4 rounded-lg flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
              <div class="flex items-start gap-4">
                <div class="icon-bubble bg-blue-100 text-blue-600">üèóÔ∏è</div>
                <div>
                  <h3 class="text-lg font-semibold"><a href="#" class="hover:underline text-blue-700">Understanding Zoning Laws</a></h3>
                  <p class="text-sm text-gray-500">John ‚Äî 2 hours ago</p>
                  <p class="text-xs text-gray-400">120 views ‚Ä¢ 15 likes</p>
                </div>
              </div>
              <p class="text-sm text-slate-500">8 replies</p>
            </article>

            <article class="thread-hover p-4 rounded-lg flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
              <div class="flex items-start gap-4">
                <div class="icon-bubble bg-green-100 text-green-600">üìã</div>
                <div>
                  <h3 class="text-lg font-semibold"><a href="#" class="hover:underline text-blue-700">Tips for Obtaining a Building Permit</a></h3>
                  <p class="text-sm text-gray-500">Sarah ‚Äî 4 hours ago</p>
                  <p class="text-xs text-gray-400">98 views ‚Ä¢ 20 likes</p>
                </div>
              </div>
              <p class="text-sm text-slate-500">12 replies</p>
            </article>

            <article class="thread-hover p-4 rounded-lg flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
              <div class="flex items-start gap-4">
                <div class="icon-bubble bg-blue-100 text-blue-600">üß±</div>
                <div>
                  <h3 class="text-lg font-semibold"><a href="#" class="hover:underline text-blue-700">Navigating the Inspection Process</a></h3>
                  <p class="text-sm text-gray-500">Michael ‚Äî 1 day ago</p>
                  <p class="text-xs text-gray-400">76 views ‚Ä¢ 8 likes</p>
                </div>
              </div>
              <p class="text-sm text-slate-500">5 replies</p>
            </article>
          </div>
        </div>

        <!-- Businesses -->
        <div id="upcoming" class="mt-12">
          <h2 class="text-2xl font-semibold mb-4">Promote your upcoming businesses</h2>
          <div class="space-y-4 mb-12">
            <article class="p-4 rounded-lg flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 bg-white">
              <div class="flex items-start gap-4">
                <div class="icon-bubble bg-green-100 text-green-600">üçΩÔ∏è</div>
                <div>
                  <h3 class="text-lg font-semibold"><a href="#" class="hover:underline text-blue-700">New Restaurant Opening</a></h3>
                  <p class="text-sm text-gray-500">Lisa ‚Äî 1 day ago</p>
                  <p class="text-xs text-gray-400">320 views ‚Ä¢ 45 likes</p>
                </div>
              </div>
              <p class="text-sm text-slate-500">9 replies</p>
            </article>

            <article class="p-4 rounded-lg flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 bg-white">
              <div class="flex items-start gap-4">
                <div class="icon-bubble bg-green-100 text-green-600">üè¨</div>
                <div>
                  <h3 class="text-lg font-semibold"><a href="#" class="hover:underline text-blue-700">Boutique Retail Store Plans</a></h3>
                  <p class="text-sm text-gray-500">David ‚Äî 2 days ago</p>
                  <p class="text-xs text-gray-400">250 views ‚Ä¢ 30 likes</p>
                </div>
              </div>
              <p class="text-sm text-slate-500">6 replies</p>
            </article>
          </div>

          <!-- FAQs + Chat -->
          <div class="mt-8 section-divider pt-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-xl font-semibold mb-4">FAQs</h3>
                <ul class="space-y-3 text-gray-700">
                  <li><strong>What are the different permit types?</strong> ‚Äì Commercial, Residential, Demolition, Use & Occupancy, Special Events, ROW, Liquor Board, and Temporary.</li>
                  <li><strong>How long does it take for approval?</strong> ‚Äì Simple permits take days; complex ones may take weeks or months.</li>
                  <li><strong>Where can I find applications?</strong> ‚Äì See Useful Links in the left navigation.</li>
                  <li><strong>Who to contact for help?</strong> ‚Äì Use the chat or submit a question from the sidebar button.</li>
                </ul>
              </div>

              <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-xl font-semibold mb-4">Need more help?</h3>
                <p class="text-sm text-gray-600">Use the chat button below to ask our AI Agent to learn more about city permit code, your permit status, and city policies.</p>
                <div class="mt-4">
                  <div id="chatbot-button" class="inline-flex" title="Chat with our AI Agent">üí¨</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Mobile Sticky Action Bar -->
    <div id="mobile-actions" class="fixed md:hidden bottom-0 inset-x-0 z-40 mobile-action-bar">
      <div class="mx-auto max-w-6xl">
        <div class="m-3 rounded-2xl shadow-lg bg-white/90 backdrop-blur border border-gray-200 px-3 py-2 flex items-center justify-between gap-2">
          <button id="act-start" class="flex-1 inline-flex items-center justify-center gap-2 text-sm font-medium px-3 py-2 rounded-xl bg-blue-600 text-white active:translate-y-px">
            <span>üí¨</span><span>Start</span>
          </button>
          <button id="act-ask" class="flex-1 inline-flex items-center justify-center gap-2 text-sm font-medium px-3 py-2 rounded-xl bg-blue-50 text-blue-700 border border-blue-200 active:translate-y-px">
            <span>üìù</span><span>Ask City</span>
          </button>
          <button id="act-chat" class="flex-1 inline-flex items-center justify-center gap-2 text-sm font-medium px-3 py-2 rounded-xl bg-gray-900 text-white active:translate-y-px">
            <span>ü§ñ</span><span>Chat</span>
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== Modals ===== -->
  <!-- Start Discussion Modal -->
  <div id="start-discussion-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-3" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="start-discussion-title">
    <div class="modal-panel bg-white rounded-lg shadow-lg p-4 sm:p-6 w-11/12 sm:w-96" role="document">
      <button class="modal-close" id="close-start" aria-label="Close start discussion modal">‚úï</button>
      <h2 id="start-discussion-title" class="text-lg sm:text-xl font-semibold mb-4">Start Discussion</h2>
      <form id="start-discussion-form" class="space-y-3">
        <label class="text-sm font-medium" for="topic">Topic</label>
        <select id="topic" class="w-full border border-gray-300 rounded-md p-2">
          <option>Permits</option><option>Zoning laws</option><option>Appeals</option>
          <option>Permit fees</option><option>Inspections</option><option>Other</option>
        </select>

        <div id="permit-type-wrap" class="hidden">
          <label class="text-sm mt-2 block" for="permit-type">Permit type</label>
          <select id="permit-type" class="w-full border border-gray-300 rounded-md p-2">
            <option>Commercial Permits</option><option>Residential Permits</option><option>Demolition Permits</option>
            <option>Use &amp; Occupancy Permits</option><option>Special Events Permits</option>
            <option>ROW (Right-of-Way) Permits</option><option>Liquor Board Permits</option>
            <option>Temporary Permits</option><option>Other / Not sure</option>
          </select>
        </div>

        <label class="text-sm font-medium" for="start-question">Question / Comment</label>
        <textarea id="start-question" rows="3" class="w-full border border-gray-300 rounded-md p-2" placeholder="What is your question or comment?"></textarea>

        <label class="text-sm font-medium" for="start-email">Email</label>
        <input id="start-email" type="email" class="w-full border border-gray-300 rounded-md p-2" placeholder="name@example.com" />

        <div class="flex flex-col sm:flex-row justify-end gap-3 mt-4">
          <button type="button" id="cancel-start" class="px-4 py-2 bg-gray-200 rounded-md w-full sm:w-auto">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md w-full sm:w-auto">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Question Modal -->
  <div id="question-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-3" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="question-title">
    <div class="modal-panel bg-white rounded-lg shadow-lg p-4 sm:p-6 w-11/12 sm:w-96" role="document">
      <button class="modal-close" id="close-question" aria-label="Close question modal">‚úï</button>
      <h2 id="question-title" class="text-lg sm:text-xl font-semibold mb-4">Submit your question to the City</h2>
      <form id="question-form" class="space-y-3">
        <label class="text-sm font-medium" for="q-topic">Topic</label>
        <select id="q-topic" class="w-full border border-gray-300 rounded-md p-2">
          <option>Permits</option><option>Zoning laws</option><option>Appeals</option>
          <option>Permit fees</option><option>Inspections</option><option>Other</option>
        </select>

        <div id="q-permit-type-wrap" class="hidden">
          <label class="text-sm mt-2 block" for="q-permit-type">Permit type</label>
          <select id="q-permit-type" class="w-full border border-gray-300 rounded-md p-2">
            <option>Commercial Permits</option><option>Residential Permits</option><option>Demolition Permits</option>
            <option>Use &amp; Occupancy Permits</option><option>Special Events Permits</option>
            <option>ROW (Right-of-Way) Permits</option><option>Liquor Board Permits</option>
            <option>Temporary Permits</option><option>Other / Not sure</option>
          </select>
        </div>

        <label class="text-sm font-medium" for="q-text">Question / Comment</label>
        <textarea id="q-text" rows="3" class="w-full border border-gray-300 rounded-md p-2" placeholder="What is your question or comment?"></textarea>

        <label class="text-sm font-medium" for="q-email">Email</label>
        <input type="email" id="q-email" placeholder="name@example.com" class="w-full border border-gray-300 rounded-md p-2" />

        <div class="flex flex-col sm:flex-row justify-end gap-3 mt-4">
          <button type="button" id="cancel-form" class="px-4 py-2 bg-gray-200 rounded-md w-full sm:w-auto">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md w-full sm:w-auto">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Chat Modal -->
  <div id="chat-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-3" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="chat-title">
    <div class="modal-panel bg-white rounded-lg shadow-lg p-4 sm:p-6 w-11/12 sm:w-96" role="document">
      <button class="modal-close" id="close-chat" aria-label="Close chat modal">‚úï</button>
      <h2 id="chat-title" class="text-lg sm:text-xl font-semibold mb-4">City Permitting Assistant</h2>
      <div class="border border-gray-200 rounded-md p-4 h-40 overflow-auto" id="chat-window">
        <div class="text-sm text-gray-800">Thank you for contacting City Permitting Assistant, what can I help you with today?</div>
      </div>
      <div class="mt-3 flex gap-2">
        <input id="chat-input" class="flex-1 border border-gray-300 rounded-md p-2" placeholder="Type your question..." />
        <button id="chat-send" class="px-4 py-2 bg-blue-600 text-white rounded-md">Send</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // ===== Worker endpoints =====
    const chatEndpoint = "https://permit-assistant.kantamneni-v.workers.dev/chat";
    const EMAIL_ENDPOINT = "https://permit-assistant.kantamneni-v.workers.dev/send-question";

    // Sidebar toggle
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('sidebar');
    if (sidebarToggle && sidebar) {
      sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
        if (!sidebar.classList.contains('hidden')) sidebar.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
      sidebar.querySelectorAll('a').forEach(a => a.addEventListener('click', () => { if (window.innerWidth < 768) sidebar.classList.add('hidden'); }));
    }

    // Accessible modal helpers
    const focusableSelector = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
    let lastActive = null;
    function openModal(modal){
      if (!modal) return;
      modal.classList.remove('hidden'); modal.classList.add('flex');
      modal.setAttribute('aria-hidden', 'false');
      lastActive = document.activeElement;
      const focusables = modal.querySelectorAll(focusableSelector);
      if (focusables.length) focusables[0].focus();
      function onKeydown(e){
        if (e.key === 'Escape') closeModal(modal);
        if (e.key === 'Tab'){
          const list = Array.from(modal.querySelectorAll(focusableSelector)).filter(el => !el.hasAttribute('disabled'));
          if (!list.length) return;
          const first = list[0], last = list[list.length-1];
          if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
          else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
        }
      }
      modal._onKeydown = onKeydown;
      document.addEventListener('keydown', onKeydown);
    }
    function closeModal(modal){
      if (!modal) return;
      modal.classList.add('hidden'); modal.classList.remove('flex');
      modal.setAttribute('aria-hidden', 'true');
      if (modal._onKeydown) document.removeEventListener('keydown', modal._onKeydown);
      if (lastActive) lastActive.focus();
    }

    // Start Discussion modal
    const startModal = document.getElementById('start-discussion-modal');
    const startBtn = document.getElementById('start-discussion-btn');
    const startCancel = document.getElementById('cancel-start');
    const startClose = document.getElementById('close-start');
    const topicSel = document.getElementById('topic');
    const permitWrap = document.getElementById('permit-type-wrap');
    const showStartModal = () => openModal(startModal);
    const hideStartModal = () => closeModal(startModal);
    startBtn?.addEventListener('click', showStartModal);
    startCancel?.addEventListener('click', hideStartModal);
    startClose?.addEventListener('click', hideStartModal);
    startModal?.addEventListener('click', (e)=>{ if(e.target === startModal) hideStartModal(); });
    function updatePermitVisibility(){ permitWrap?.classList.toggle('hidden', topicSel?.value !== 'Permits'); }
    topicSel?.addEventListener('change', updatePermitVisibility); updatePermitVisibility();
    document.getElementById('start-discussion-form')?.addEventListener('submit', (e)=>{ e.preventDefault(); alert('Discussion submitted (demo).'); hideStartModal(); });

    // Question modal
    const questionModal = document.getElementById('question-modal');
    const openQuestion = document.getElementById('submit-question-header');
    const cancelQuestion = document.getElementById('cancel-form');
    const closeQuestion = document.getElementById('close-question');
    const qTopicSel = document.getElementById('q-topic');
    const qPermitWrap = document.getElementById('q-permit-type-wrap');
    const showQuestion = () => openModal(questionModal);
    const hideQuestion = () => closeModal(questionModal);
    openQuestion?.addEventListener('click', showQuestion);
    cancelQuestion?.addEventListener('click', hideQuestion);
    closeQuestion?.addEventListener('click', hideQuestion);
    questionModal?.addEventListener('click', (e)=>{ if(e.target === questionModal) hideQuestion(); });
    function updateQPermitVisibility(){ qPermitWrap?.classList.toggle('hidden', qTopicSel?.value !== 'Permits'); }
    qTopicSel?.addEventListener('change', updateQPermitVisibility); updateQPermitVisibility();

    // Email submit -> Worker
    const questionForm = document.getElementById('question-form');
    if (questionForm) questionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const topic = document.getElementById('q-topic')?.value?.trim() || "";
      const permitType = (qPermitWrap && !qPermitWrap.classList.contains('hidden')) ? (document.getElementById('q-permit-type')?.value?.trim() || "") : "";
      const message = document.getElementById('q-text')?.value?.trim() || "";
      const email = document.getElementById('q-email')?.value?.trim() || "";

      if (!message) { alert("Please enter your question or comment."); return; }
      if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { alert("Please enter a valid email address."); return; }

      const submitBtn = questionForm.querySelector('button[type="submit"]');
      const prev = submitBtn?.textContent;
      submitBtn && (submitBtn.disabled = true, submitBtn.textContent = "Sending...");

      try {
        const res = await fetch(EMAIL_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ topic, permitType, message, email })
        });
        if (!res.ok) throw new Error(await res.text());
        alert("Your question has been sent! Check your email for a confirmation.");
        questionForm.reset();
        if (qTopicSel && qPermitWrap) qPermitWrap.classList.toggle('hidden', qTopicSel.value !== 'Permits');
        hideQuestion();
      } catch (err) {
        console.error(err);
        alert("Sorry, there was a problem sending your question. If it persists, contact support.");
      } finally {
        submitBtn && (submitBtn.disabled = false, submitBtn.textContent = prev || "Submit");
      }
    });

    // Chat modal
    const chatModal = document.getElementById('chat-modal');
    const chatBtn = document.getElementById('chatbot-button');
    const closeChat = document.getElementById('close-chat');
    const showChat = () => openModal(chatModal);
    const hideChat = () => closeModal(chatModal);
    chatBtn?.addEventListener('click', showChat);
    closeChat?.addEventListener('click', hideChat);
    chatModal?.addEventListener('click', (e)=>{ if(e.target === chatModal) hideChat(); });

    // Chat -> Worker
    async function sendChat(){
    const input = document.getElementById('chat-input');
    const win = document.getElementById('chat-window');
    if (!input || !win) return;

    const msg = input.value.trim();
    if (!msg) return;

    const userDiv = document.createElement('div');
    userDiv.className = 'text-sm text-gray-700 mt-2';
    userDiv.textContent = 'You: ' + msg;
    win.appendChild(userDiv);
    input.value = '';

    const typing = document.createElement('div');
    typing.className = 'text-sm text-gray-400 mt-2 italic';
    typing.textContent = 'Assistant is typing‚Ä¶';
    win.appendChild(typing);
    win.scrollTop = win.scrollHeight;

    // 20s timeout so we don‚Äôt hang forever
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), 20000);

    try{
      const res = await fetch(chatEndpoint, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-store',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg }),
        signal: ctrl.signal
      });

      const bodyText = await res.text(); // don‚Äôt assume JSON
      clearTimeout(t);
      typing.remove();

      if (!res.ok) {
        const er = document.createElement('div');
        er.className = 'text-sm text-red-600 mt-2';
        er.textContent = `Chat error (${res.status}): ${bodyText || 'No response body'}`;
        win.appendChild(er);
        return;
      }

      const bot = document.createElement('div');
      bot.className = 'text-sm text-gray-800 mt-2 font-medium';
      bot.textContent = bodyText || 'No response.';
      win.appendChild(bot);
      win.scrollTop = win.scrollHeight;

    }catch(err){
      clearTimeout(t);
      typing.remove();
      const er = document.createElement('div');
      er.className = 'text-sm text-red-600 mt-2';
      er.textContent = `Network error: ${err?.name === 'AbortError' ? 'request timed out' : (err?.message || 'unknown')}`;
      win.appendChild(er);
    }
  }

    document.getElementById('chat-send')?.addEventListener('click', sendChat);
    document.getElementById('chat-input')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); } });

    // Mobile quick actions
    document.getElementById('act-start')?.addEventListener('click', showStartModal);
    document.getElementById('act-ask')?.addEventListener('click', showQuestion);
    document.getElementById('act-chat')?.addEventListener('click', showChat);
  </script>
</body>
</html>


